<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SAP BO Object Picker</title>

<style>
:root{
  --bg:#0b1220;
  --panel:#020617;
  --border:#1e293b;
  --accent:#38bdf8;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

*{box-sizing:border-box;font-family:system-ui;}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:14px 20px;
  font-size:18px;
  border-bottom:1px solid var(--border);
}

.app{
  display:grid;
  grid-template-columns:220px 1fr 300px;
  height:calc(100vh - 54px);
}

/* ---------- LEFT NAV ---------- */
.nav{
  border-right:1px solid var(--border);
  padding:14px;
}

.nav button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
  cursor:pointer;
}

.nav button:hover,
.nav button.active{
  border-color:var(--accent);
}

/* ---------- MAIN ---------- */
.main{
  display:flex;
  flex-direction:column;
}

.toolbar{
  padding:10px;
  border-bottom:1px solid var(--border);
}

.toolbar input{
  width:100%;
  padding:10px;
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
}

.list{
  padding:14px;
  overflow:auto;
}

.item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
  margin-bottom:8px;
  cursor:pointer;
}

.item:hover{border-color:var(--accent);}
.item.selected{background:rgba(56,189,248,.15);}

.icon{
  width:16px;
  height:16px;
  fill:var(--muted);
  cursor:pointer;
}

.name{flex:1;}
.small{font-size:12px;color:var(--muted);}

/* ---------- RIGHT ---------- */
.right{
  border-left:1px solid var(--border);
  padding:14px;
  display:flex;
  flex-direction:column;
}

textarea{
  flex:1;
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px;
  border-radius:6px;
  resize:none;
}

.copy{
  margin-top:10px;
  padding:10px;
  background:var(--accent);
  border:none;
  font-weight:600;
  border-radius:6px;
  cursor:pointer;
}

/* ---------- AUTH ---------- */
.auth{
  max-width:420px;
  margin:80px auto;
  padding:20px;
  border:1px solid var(--border);
  border-radius:8px;
}

.auth input{
  width:100%;
  margin-bottom:10px;
  padding:10px;
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:6px;
}

.auth button{
  width:100%;
  padding:10px;
  background:var(--accent);
  border:none;
  font-weight:600;
  border-radius:6px;
  cursor:pointer;
}

.hidden{display:none;}
</style>
</head>

<body>
<header>SAP BO Object Picker</header>

<!-- AUTH -->
<div class="auth" id="auth">
  <h3>Login</h3>
  <input id="server" placeholder="Server URL (https://bo.company.com)">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="status"></div>
</div>

<!-- APP -->
<div class="app hidden" id="app">

  <div class="nav">
    <button onclick="loadReports(this)">Reports</button>
    <button onclick="loadUniverses(this)">Universes</button>
    <button onclick="loadConnections(this)">Connections</button>
  </div>

  <div class="main">
    <div class="toolbar">
      <input placeholder="Search…" oninput="filter(this.value)">
    </div>
    <div class="list" id="list"></div>
  </div>

  <div class="right">
    <h4>Selected CUIDs</h4>
    <textarea id="cuids" readonly></textarea>
    <button class="copy" onclick="copy()">Copy</button>
  </div>

</div>

<script>
let BASE="", TOKEN="";
let cache=[];
const selected=new Set();

/* ---------- LOGIN ---------- */
async function login(){
  const s=server.value.trim().replace(/\/$/,"");
  status.textContent="Authenticating…";

  const r=await fetch(`${s}/biprws/logon/long`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      userName:user.value,
      password:pass.value,
      auth:"secEnterprise"
    })
  });

  if(!r.ok){status.textContent="Login failed";return;}

  const xml=await r.text();
  TOKEN=xml.match(/<attr name="logonToken".*?>(.*?)</)?.[1];
  BASE=`${s}/biprws/v1`;

  auth.classList.add("hidden");
  app.classList.remove("hidden");
}

/* ---------- API ---------- */
async function api(path,method="GET",body){
  const r=await fetch(BASE+path,{
    method,
    headers:{
      "X-SAP-LogonToken":TOKEN,
      "Content-Type":"application/json"
    },
    body:body?JSON.stringify(body):null
  });
  return r.json();
}

/* ---------- REPORTS ---------- */
async function loadReports(btn){
  activate(btn);
  const d=await api("/folders");
  render(d.folders||[]);
}

async function openFolder(id){
  const d=await api(`/folders/${id}/children`);
  render(d.entries||[]);
}

/* ---------- CMS QUERY ---------- */
async function loadUniverses(btn){
  activate(btn);
  cmsQuery();
}

async function loadConnections(btn){
  activate(btn);
  cmsQuery();
}

async function cmsQuery(parentCuid=""){
  const q=`
    SELECT SI_ID,SI_CUID,SI_NAME,SI_KIND
    FROM CI_APPOBJECTS,CI_SYSTEMOBJECTS
    ${parentCuid?`WHERE SI_PARENT_CUID='${parentCuid}'`:""}
    ORDER BY SI_KIND`;

  const d=await api("/cmsquery","POST",{query:q});
  render(d.entries||[]);
}

/* ---------- RENDER ---------- */
function render(items){
  cache=items;
  list.innerHTML="";

  items.forEach(o=>{
    const isFolder=o.kind==="Folder";
    const div=document.createElement("div");
    div.className="item";
    if(selected.has(o.cuid))div.classList.add("selected");

    div.innerHTML=`
      ${isFolder?folderIcon():""}
      <div class="name">
        ${o.name}
        <div class="small">${o.cuid||""}</div>
      </div>
    `;

    if(isFolder){
      div.querySelector("svg").onclick=e=>{
        e.stopPropagation();
        cmsQuery(o.cuid);
      };
    }

    div.onclick=()=>{
      if(o.cuid)toggle(o.cuid,div);
    };

    list.appendChild(div);
  });
}

/* ---------- UI ---------- */
function filter(t){
  t=t.toLowerCase();
  render(cache.filter(o=>
    o.name.toLowerCase().includes(t)||
    (o.cuid||"").toLowerCase().includes(t)
  ));
}

function toggle(c,el){
  selected.has(c)?selected.delete(c):selected.add(c);
  el.classList.toggle("selected");
  cuids.value=[...selected].join("\n");
}

function copy(){navigator.clipboard.writeText(cuids.value);}

function activate(btn){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ---------- ICON ---------- */
function folderIcon(){
return `<svg class="icon" viewBox="0 0 24 24">
<path d="M10 4l2 2h8v12H4V4z"/></svg>`;
}
</script>
</body>
</html>
