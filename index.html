<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SAP BO Object Picker</title>

<style>
:root{
  --bg:#ffffff;
  --panel:#f9fafb;
  --border:#e5e7eb;
  --primary:#dc2626;
  --primary-soft:#fee2e2;
  --text:#111827;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:system-ui,Segoe UI;}

body{margin:0;background:var(--bg);color:var(--text);}
header{
  padding:14px 20px;
  font-size:18px;
  font-weight:600;
  border-bottom:1px solid var(--border);
}

.hidden{display:none;}

.auth{
  max-width:420px;
  margin:80px auto;
  padding:24px;
  border:1px solid var(--border);
  border-radius:10px;
}

.auth input{
  width:100%;
  margin-bottom:12px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
}

.auth button{
  width:100%;
  padding:10px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}

#status{font-size:13px;color:var(--muted);}

.app{
  display:grid;
  grid-template-columns:220px 1fr 320px;
  height:calc(100vh - 56px);
}

.app.disabled{opacity:0.5;pointer-events:none}
/* NAV */
.nav{
  border-right:1px solid var(--border);
  padding:14px;
}

.nav button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:6px;
  cursor:pointer;
}

.nav button.active{
  border-color:var(--primary);
  color:var(--primary);
}

/* MAIN */
.main{display:flex;flex-direction:column;}
.toolbar{
  padding:10px;
  border-bottom:1px solid var(--border);
}
.toolbar input{
  width:100%;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
}

.breadcrumbs{
  padding:8px 14px;
  font-size:13px;
  border-bottom:1px solid var(--border);
}

.breadcrumbs span{
  color:var(--primary);
  cursor:pointer;
}

.list{
  padding:14px;
  background:var(--panel);
  overflow:auto;
}

/* ITEM */
.item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
  background:#fff;
  margin-bottom:8px;
  cursor:pointer;
}

.item:hover{border-color:var(--primary);}
.item.selected{
  background:var(--primary-soft);
  border-color:var(--primary);
}

.icon{
  width:16px;
  height:16px;
  fill:var(--primary);
  cursor:pointer;
}

.name{flex:1;}
.small{font-size:12px;color:var(--muted);}

/* RIGHT */
.right{
  border-left:1px solid var(--border);
  padding:14px;
  display:flex;
  flex-direction:column;
}

textarea{
  flex:1;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
  resize:none;
}

.copy{
  margin-top:10px;
  padding:10px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  font-weight:600;
}
</style>
</head>

<body>
<header>SAP BO Object Picker</header>

<!-- LOGIN -->
<div class="auth hidden" id="auth">
  <h3>Login</h3>
  <input id="server" placeholder="Server URL (https://bo.company.com)">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="status"></div>
</div>

<!-- APP -->
<div class="app hidden" id="app">
  <div class="nav">
    <button onclick="loadReports(this)">Reports</button>
    <button onclick="loadUniverses(this)">Universes</button>
    <button onclick="loadConnections(this)">Connections</button>
  </div>

  <div class="main">
    <div class="toolbar">
      <input placeholder="Search…" oninput="filter(this.value)">
    </div>
    <div class="breadcrumbs" id="crumbs"></div>
    <div class="list" id="list"></div>
  </div>

  <div class="right">
    <h4>Selected CUIDs</h4>
    <textarea id="cuids" readonly></textarea>
    <button class="copy" onclick="copy()">Copy</button>
  </div>
</div>

<script>
/* ===== STATE ===== */
let BASE="", TOKEN="";
let cache=[], breadcrumbs=[], currentMode="";
let authFailures=0;
const MAX_AUTH_FAILURES=3;
const selected=new Set();

const ROOT_UNIVERSE_CUID="FA_UniversesRoot";
const ROOT_CONNECTION_CUID="FA_ConnectionsRoot";

/* ===== INIT ===== */
(function(){
  // get DOM refs early
  window.auth = document.getElementById("auth");
  window.app = document.getElementById("app");
  window.status = document.getElementById("status");
  window.server = document.getElementById("server");
  window.user = document.getElementById("user");
  window.pass = document.getElementById("pass");
  window.list = document.getElementById("list");
  window.crumbs = document.getElementById("crumbs");
  window.cuids = document.getElementById("cuids");

  // default: show UI but disabled until auth validated
  app.classList.remove("hidden");
  app.classList.add("disabled");

  const s=JSON.parse(localStorage.getItem("boSession")||"null");
  if(s?.token && s?.server){
    TOKEN=s.token;
    BASE=`${s.server}/biprws/v1`;
    // validate token by hitting a lightweight endpoint
    api('/folders').then(d=>{
      // if API returned entries it's valid
      app.classList.remove('disabled');
      showApp();
    }).catch(()=>{
      // invalid: show auth
      app.classList.add('disabled');
      auth.classList.remove('hidden');
    });
  }else{
    auth.classList.remove("hidden");
  }
})();

/* ===== LOGIN ===== */
async function login(){
  const s=document.getElementById('server').value.trim().replace(/\/$/,"");
  status.textContent="Authenticating…";

  const r=await fetch(`${s}/biprws/logon/long`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      userName:user.value,
      password:pass.value,
      auth:"secEnterprise"
    })
  });

  if(!r.ok){status.textContent="Login failed";return;}
  const xml=await r.text();
  TOKEN=xml.match(/<attr name="logonToken"[^>]*>(.*?)</)?.[1];
  if(!TOKEN){ status.textContent='Login: token not found'; return; }
  BASE=`${s}/biprws/v1`;

  localStorage.setItem("boSession",JSON.stringify({token:TOKEN,server:s}));
  // enable app and hide auth
  app.classList.remove('disabled');
  auth.classList.add('hidden');
  showApp();
}

function showApp(){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
}

/* ===== API (SAFE) ===== */
async function api(path,method="GET",body){
  const r=await fetch(BASE+path,{
    method,
    headers:{
      "X-SAP-LogonToken":TOKEN,
      "Content-Type":"application/json"
    },
    body:body?JSON.stringify(body):null
  });

  if(r.status===401||r.status===403){
    authFailures++;
    if(authFailures>=MAX_AUTH_FAILURES){
      logout();
      throw new Error("Session expired");
    }
    return {entries:[]};
  }

  authFailures=0;
  return r.json();
}

function logout(){
  localStorage.removeItem("boSession");
  authFailures=0;
  app.classList.add("hidden");
  auth.classList.remove("hidden");
}

/* ===== REPORTS ===== */
async function loadReports(btn){
  activate(btn);
  currentMode="reports";
  breadcrumbs=[{label:"Root",id:null}];
  updateCrumbs();
  const d=await api("/folders");
  render(d.entries||[],'reports');
}

async function openFolder(id,name){
  breadcrumbs.push({label:name,id});
  updateCrumbs();
  const d=await api(`/folders/${id}/children`);
  render(d.entries||[]);
}

/* ===== CMS ===== */
async function loadUniverses(btn){
  activate(btn);
  currentMode="cms";
  breadcrumbs=[{label:"Universes",cuid:ROOT_UNIVERSE_CUID}];
  updateCrumbs();
  cms(ROOT_UNIVERSE_CUID);
}

async function loadConnections(btn){
  activate(btn);
  currentMode="cms";
  breadcrumbs=[{label:"Connections",cuid:ROOT_CONNECTION_CUID}];
  updateCrumbs();
  cms(ROOT_CONNECTION_CUID);
}

async function cms(parent){
  const q=`SELECT SI_ID,SI_CUID,SI_NAME,SI_KIND
           FROM CI_APPOBJECTS,CI_SYSTEMOBJECTS
           WHERE SI_PARENT_CUID='${parent}'
           ORDER BY SI_KIND`;
  const d=await api("/cmsquery","POST",{query:q});
  // cmsquery can return results in different fields; normalize
  render(d.entries||d.results||[],'cms');
}

/* ===== RENDER ===== */
function render(items,mode){
  // normalize items into {id,cuid,name,kind,isFolder,raw}
  const norm = (o)=>{
    const name = o.name || o.SI_NAME || o.SI_NAME || o.si_name || "";
    const kind = o.kind || o.type || o.SI_KIND || o.SI_KIND || "";
    const cuid = o.SI_CUID || o.cuid || o.CUID || null;
    const id = o.id || o.ID || o.SI_ID || null;
    const isFolder = (kind && String(kind).toLowerCase().includes('folder')) || false;
    return {raw:o,id,cuid,name,kind,isFolder};
  };

  cache = items.map(norm);
  list.innerHTML = "";
  cache.forEach(o=>{
    const div = document.createElement('div');
    div.className = 'item';
    const key = o.cuid || o.id || '';
    if(selected.has(key)) div.classList.add('selected');

    div.innerHTML = `
      ${o.isFolder?folderIcon():""}
      <div class="name">${escapeHtml(o.name)}<div class="small">${escapeHtml(key)}</div></div>
    `;

    if(o.isFolder){
      const svg = div.querySelector('svg');
      if(svg) svg.onclick = e => {
        e.stopPropagation();
        if(mode==='reports') openFolder(o.id,o.name);
        else{
          breadcrumbs.push({label:o.name,cuid:o.cuid});
          updateCrumbs();
          cms(o.cuid || o.id);
        }
      };
    }

    div.onclick = ()=>{
      // select non-folder items; use id or cuid as identifier
      const ident = o.cuid || o.id || '';
      if(!o.isFolder && ident) toggle(ident,div);
    };

    list.appendChild(div);
  });
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ===== BREADCRUMBS ===== */
function updateCrumbs(){
  crumbs.innerHTML=breadcrumbs.map((b,i)=>
    `<span onclick="crumb(${i})">${b.label}</span>`
  ).join(" / ");
}

function crumb(i){
  breadcrumbs=breadcrumbs.slice(0,i+1);
  updateCrumbs();
  const b=breadcrumbs[i];
  currentMode==="reports"
    ? (b.id?openFolder(b.id,b.label):loadReports(document.querySelector(".nav button.active")))
    : cms(b.cuid);
}

/* ===== UTIL ===== */
function filter(t){
  t=t.toLowerCase();
  render(cache.filter(o=>o.name.toLowerCase().includes(t)||(o.cuid||"").toLowerCase().includes(t)));
}
function toggle(c,el){
  selected.has(c)?selected.delete(c):selected.add(c);
  el.classList.toggle("selected");
  cuids.value=[...selected].join("\n");
}
function copy(){navigator.clipboard.writeText(cuids.value);}
function activate(btn){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function folderIcon(){
  return `<svg class="icon" viewBox="0 0 24 24">
    <path d="M10 4l2 2h8v12H4V4z"/></svg>`;
}
</script>
</body>
</html>
