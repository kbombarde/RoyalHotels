<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SAP BO Object Picker</title>

<style>
:root{
  --bg:#0b1220;--panel:#020617;--border:#1e293b;
  --accent:#38bdf8;--text:#e5e7eb;--muted:#94a3b8;
}
*{box-sizing:border-box;font-family:system-ui;}
body{margin:0;background:var(--bg);color:var(--text);}
header{padding:14px 20px;border-bottom:1px solid var(--border);}

.hidden{display:none;}
.app{display:grid;grid-template-columns:220px 1fr 300px;height:calc(100vh - 54px);}
.nav{border-right:1px solid var(--border);padding:14px;}
.nav button{width:100%;padding:10px;margin-bottom:10px;background:transparent;border:1px solid var(--border);color:var(--text);border-radius:6px;cursor:pointer;}
.nav button.active{border-color:var(--accent);}

.main{display:flex;flex-direction:column;}
.toolbar{padding:10px;border-bottom:1px solid var(--border);}
.toolbar input{width:100%;padding:10px;background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:6px;}
.breadcrumbs{padding:8px 14px;font-size:13px;color:var(--muted);}
.breadcrumbs span{cursor:pointer;}
.list{padding:14px;overflow:auto;}

.item{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer;}
.item:hover{border-color:var(--accent);}
.item.selected{background:rgba(56,189,248,.15);}
.icon{width:16px;height:16px;fill:var(--muted);cursor:pointer;}
.name{flex:1;}
.small{font-size:12px;color:var(--muted);}

.right{border-left:1px solid var(--border);padding:14px;display:flex;flex-direction:column;}
textarea{flex:1;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:6px;}
.copy{margin-top:10px;padding:10px;background:var(--accent);border:none;border-radius:6px;font-weight:600;cursor:pointer;}

.auth{max-width:420px;margin:80px auto;padding:20px;border:1px solid var(--border);border-radius:8px;}
.auth input{width:100%;margin-bottom:10px;padding:10px;background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:6px;}
.auth button{width:100%;padding:10px;background:var(--accent);border:none;border-radius:6px;font-weight:600;}
</style>
</head>

<body>
<header>SAP BO Object Picker</header>

<!-- AUTH -->
<div class="auth hidden" id="auth">
  <h3>Login</h3>
  <input id="server" placeholder="Server URL (https://bo.company.com)">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="status"></div>
</div>

<!-- APP -->
<div class="app hidden" id="app">
  <div class="nav">
    <button onclick="loadReports(this)">Reports</button>
    <button onclick="loadUniverses(this)">Universes</button>
    <button onclick="loadConnections(this)">Connections</button>
  </div>

  <div class="main">
    <div class="toolbar">
      <input placeholder="Search…" oninput="filter(this.value)">
    </div>
    <div class="breadcrumbs" id="crumbs"></div>
    <div class="list" id="list"></div>
  </div>

  <div class="right">
    <h4>Selected CUIDs</h4>
    <textarea id="cuids" readonly></textarea>
    <button class="copy" onclick="copy()">Copy</button>
  </div>
</div>

<script>
/* ---------- STATE ---------- */
let BASE="", TOKEN="";
let cache=[], breadcrumbs=[];
let currentMode="";
const selected=new Set();

const ROOT_UNIVERSE_CUID="FA_UniversesRoot";
const ROOT_CONNECTION_CUID="FA_ConnectionsRoot";

/* ---------- INIT ---------- */
(function init(){
  const saved=JSON.parse(localStorage.getItem("boSession")||"null");
  if(saved?.token && saved?.server){
    TOKEN=saved.token;
    BASE=`${saved.server}/biprws/v1`;
    showApp();
  }else{
    auth.classList.remove("hidden");
  }
})();

/* ---------- LOGIN ---------- */
async function login(){
  const s=server.value.trim().replace(/\/$/,"");
  status.textContent="Authenticating…";

  const r=await fetch(`${s}/biprws/logon/long`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userName:user.value,password:pass.value,auth:"secEnterprise"})
  });

  if(!r.ok){status.textContent="Login failed";return;}

  const xml=await r.text();
  TOKEN=xml.match(/<attr name="logonToken".*?>(.*?)</)?.[1];
  BASE=`${s}/biprws/v1`;

  localStorage.setItem("boSession",JSON.stringify({token:TOKEN,server:s}));
  showApp();
}

function showApp(){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
}

/* ---------- API ---------- */
async function api(path,method="GET",body){
  const r=await fetch(BASE+path,{
    method,
    headers:{
      "X-SAP-LogonToken":TOKEN,
      "Content-Type":"application/json"
    },
    body:body?JSON.stringify(body):null
  });

  if(r.status===401||r.status===403){
    logout();
    throw new Error("Session expired");
  }
  return r.json();
}

function logout(){
  localStorage.removeItem("boSession");
  location.reload();
}

/* ---------- REPORTS ---------- */
async function loadReports(btn){
  activate(btn);
  currentMode="reports";
  breadcrumbs=[{label:"Root",id:null}];
  updateCrumbs();
  const d=await api("/folders");
  render(d.entries||[]);
}

async function openFolder(id,name){
  breadcrumbs.push({label:name,id});
  updateCrumbs();
  const d=await api(`/folders/${id}/children`);
  render(d.entries||[]);
}

/* ---------- CMS ---------- */
async function loadUniverses(btn){
  activate(btn);
  currentMode="universe";
  breadcrumbs=[{label:"Universes",cuid:ROOT_UNIVERSE_CUID}];
  updateCrumbs();
  cms(ROOT_UNIVERSE_CUID);
}

async function loadConnections(btn){
  activate(btn);
  currentMode="connection";
  breadcrumbs=[{label:"Connections",cuid:ROOT_CONNECTION_CUID}];
  updateCrumbs();
  cms(ROOT_CONNECTION_CUID);
}

async function cms(parentCuid){
  const q=`SELECT SI_ID,SI_CUID,SI_NAME,SI_KIND FROM CI_APPOBJECTS,CI_SYSTEMOBJECTS WHERE SI_PARENT_CUID='${parentCuid}' ORDER BY SI_KIND`;
  const d=await api("/cmsquery","POST",{query:q});
  render(d.entries||[]);
}

/* ---------- RENDER ---------- */
function render(items){
  cache=items;
  list.innerHTML="";
  items.forEach(o=>{
    const isFolder=o.kind==="Folder";
    const div=document.createElement("div");
    div.className="item";
    if(selected.has(o.cuid))div.classList.add("selected");

    div.innerHTML=`
      ${isFolder?folderIcon():""}
      <div class="name">${o.name}<div class="small">${o.cuid||""}</div></div>
    `;

    if(isFolder){
      div.querySelector("svg").onclick=e=>{
        e.stopPropagation();
        if(currentMode==="reports") openFolder(o.id,o.name);
        else{
          breadcrumbs.push({label:o.name,cuid:o.cuid});
          updateCrumbs();
          cms(o.cuid);
        }
      };
    }

    div.onclick=()=>{ if(o.cuid)toggle(o.cuid,div); };
    list.appendChild(div);
  });
}

/* ---------- BREADCRUMBS ---------- */
function updateCrumbs(){
  crumbs.innerHTML=breadcrumbs.map((b,i)=>
    `<span onclick="crumb(${i})">${b.label}</span>`
  ).join(" / ");
}

async function crumb(i){
  breadcrumbs=breadcrumbs.slice(0,i+1);
  updateCrumbs();
  const b=breadcrumbs[i];
  if(currentMode==="reports"){
    if(!b.id) loadReports(document.querySelector(".nav button.active"));
    else openFolder(b.id,b.label);
  }else{
    cms(b.cuid);
  }
}

/* ---------- UTIL ---------- */
function filter(t){
  t=t.toLowerCase();
  render(cache.filter(o=>o.name.toLowerCase().includes(t)||(o.cuid||"").toLowerCase().includes(t)));
}
function toggle(c,el){
  selected.has(c)?selected.delete(c):selected.add(c);
  el.classList.toggle("selected");
  cuids.value=[...selected].join("\n");
}
function copy(){navigator.clipboard.writeText(cuids.value);}
function activate(btn){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function folderIcon(){
  return `<svg class="icon" viewBox="0 0 24 24"><path d="M10 4l2 2h8v12H4V4z"/></svg>`;
}
</script>
</body>
</html>
