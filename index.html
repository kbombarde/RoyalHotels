<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SAP BO Object Picker</title>

<style>
:root{
  --red:#dc2626;
  --border:#e5e7eb;
  --bg:#ffffff;
  --panel:#f9fafb;
  --text:#111827;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:system-ui;}

body{margin:0;background:var(--bg);color:var(--text);}
header{padding:14px 20px;font-weight:600;border-bottom:1px solid var(--border);}

.hidden{display:none;}

.auth{
  max-width:420px;
  margin:80px auto;
  padding:24px;
  border:1px solid var(--border);
  border-radius:8px;
}

.auth input,.auth button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
}

.auth button{
  background:var(--red);
  color:white;
  border:none;
  font-weight:600;
}

.app{
  display:grid;
  grid-template-columns:220px 1fr 320px;
  height:calc(100vh - 56px);
}

.nav{
  border-right:1px solid var(--border);
  padding:14px;
}

.nav button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border:1px solid var(--border);
  background:white;
  cursor:pointer;
}

.nav button.active{
  border-color:var(--red);
  color:var(--red);
}

.main{
  display:flex;
  flex-direction:column;
}

.breadcrumbs{
  padding:8px 14px;
  font-size:13px;
  border-bottom:1px solid var(--border);
}

.breadcrumbs span{
  cursor:pointer;
  color:var(--red);
}

.list{
  padding:14px;
  background:var(--panel);
  overflow:auto;
}

.item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:6px;
  background:white;
  margin-bottom:8px;
  cursor:pointer;
}

.item:hover{border-color:var(--red);}
.item.selected{background:#fee2e2;border-color:var(--red);}

.icon{
  width:16px;
  height:16px;
  fill:var(--red);
}

.right{
  border-left:1px solid var(--border);
  padding:14px;
  display:flex;
  flex-direction:column;
}

textarea{flex:1;padding:10px;}
button.copy{
  margin-top:10px;
  background:var(--red);
  color:white;
  border:none;
  padding:10px;
}
</style>
</head>

<body>
<header>SAP BO Object Picker</header>

<!-- LOGIN -->
<div class="auth hidden" id="auth">
  <input id="server" placeholder="Server URL">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="status"></div>
</div>

<!-- APP -->
<div class="app hidden" id="app">

  <div class="nav">
    <button onclick="loadReports(this)">Reports</button>
    <button onclick="loadUniverses(this)">Universes</button>
    <button onclick="loadConnections(this)">Connections</button>
  </div>

  <div class="main">
    <div class="breadcrumbs" id="crumbs"></div>
    <div class="list" id="list"></div>
  </div>

  <div class="right">
    <h4>Selected CUIDs</h4>
    <textarea id="cuids" readonly></textarea>
    <button class="copy" onclick="copy()">Copy</button>
  </div>

</div>

<script>
let BASE="", TOKEN="";
let mode="";
let crumbs=[];
const selected=new Set();

const ROOT_UNIVERSE_CUID="faiegsiegeosheteoeg";
const ROOT_CONNECTION_CUID="faiegsiegeosheteoeg";

/* INIT */
(function(){
  const s=JSON.parse(localStorage.getItem("boSession")||"null");
  if(s?.token){
    TOKEN=s.token;
    BASE=s.base;
    showApp();
  }else auth.classList.remove("hidden");
})();

/* LOGIN */
async function login(){
  const s=server.value.replace(/\/$/,"");
  status.textContent="Authenticatingâ€¦";

  const r=await fetch(`${s}/biprws/logon/long`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userName:user.value,password:pass.value,auth:"secEnterprise"})
  });

  const xml=await r.text();
  TOKEN=xml.match(/<attr name="logonToken".*?>(.*?)</)?.[1];
  BASE=`${s}/biprws/v1`;

  localStorage.setItem("boSession",JSON.stringify({token:TOKEN,base:BASE}));
  showApp();
}

function showApp(){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
}

/* API */
async function api(url,method="GET",body){
  const r=await fetch(BASE+url,{
    method,
    headers:{
      "X-SAP-LogonToken":TOKEN,
      "Content-Type":"application/json"
    },
    body:body?JSON.stringify(body):null
  });
  return r.json();
}

/* REPORTS */
async function loadReports(btn){
  setMode(btn,"reports");
  crumbs=[{label:"Root"}];
  renderCrumbs();
  const d=await api("/folders");
  renderList(d.entries,true);
}

async function openFolder(id,name){
  crumbs.push({label:name,id});
  renderCrumbs();
  const d=await api(`/folders/${id}/children`);
  renderList(d.entries,true);
}

/* CMS */
async function loadUniverses(btn){
  setMode(btn,"cms");
  crumbs=[{label:"Universes",cuid:ROOT_UNIVERSE_CUID}];
  renderCrumbs();
  cms(ROOT_UNIVERSE_CUID);
}

async function loadConnections(btn){
  setMode(btn,"cms");
  crumbs=[{label:"Connections",cuid:ROOT_CONNECTION_CUID}];
  renderCrumbs();
  cms(ROOT_CONNECTION_CUID);
}

async function cms(parent){
  const q=`SELECT SI_ID, SI_CUID, SI_NAME, SI_KIND
           FROM CI_APPOBJECTS, CI_SYSTEMOBJECTS
           WHERE SI_PARENT_CUID='${parent}'
           ORDER BY SI_KIND`;
  const d=await api("/cmsquery","POST",{query:q});
  renderList(d.entries,false);
}

/* RENDER */
function renderList(items,isReport){
  list.innerHTML="";
  items.forEach(o=>{
    const isFolder=isReport ? o.type==="Folder" : o.kind==="Folder";
    const div=document.createElement("div");
    div.className="item";

    div.innerHTML=`
      ${isFolder?folderIcon():""}
      <div>${o.name}<div style="font-size:12px;color:#6b7280">${o.cuid||""}</div></div>
    `;

    if(isFolder){
      div.querySelector("svg").onclick=e=>{
        e.stopPropagation();
        isReport?openFolder(o.id,o.name):(crumbs.push({label:o.name,cuid:o.cuid}),renderCrumbs(),cms(o.cuid));
      };
    }

    div.onclick=()=>{ if(o.cuid)toggle(o.cuid,div); };
    list.appendChild(div);
  });
}

/* BREADCRUMBS */
function renderCrumbs(){
  crumbsEl.innerHTML=crumbs.map((c,i)=>`<span onclick="goCrumb(${i})">${c.label}</span>`).join(" / ");
}
const crumbsEl=document.getElementById("crumbs");

function goCrumb(i){
  crumbs=crumbs.slice(0,i+1);
  renderCrumbs();
  const c=crumbs[i];
  mode==="reports"?loadReports(document.querySelector(".nav button.active")):cms(c.cuid);
}

/* UTILS */
function toggle(c,el){
  selected.has(c)?selected.delete(c):selected.add(c);
  el.classList.toggle("selected");
  cuids.value=[...selected].join("\n");
}
function copy(){navigator.clipboard.writeText(cuids.value);}
function setMode(btn,m){
  mode=m;
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function folderIcon(){
  return `<svg class="icon" viewBox="0 0 24 24"><path d="M10 4l2 2h8v12H4V4z"/></svg>`;
}
</script>
</body>
</html>
